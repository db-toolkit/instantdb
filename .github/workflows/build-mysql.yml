name: Build MySQL Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - 'binaries-*'

jobs:
  build:
    name: Build MySQL ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            artifact: mysql-8.0.40-darwin-universal.tar.gz
          - os: ubuntu-latest
            artifact: mysql-8.0.40-linux-amd64.tar.gz
          - os: windows-latest
            artifact: mysql-8.0.40-windows-amd64.zip

    steps:
      - uses: actions/checkout@v4

      - name: Download MySQL (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.40-macos14-arm64.tar.gz
          wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.40-macos14-x86_64.tar.gz
          tar xzf mysql-8.0.40-macos14-arm64.tar.gz
          tar xzf mysql-8.0.40-macos14-x86_64.tar.gz
          mkdir -p mysql-universal/bin mysql-universal/lib
          lipo -create mysql-8.0.40-macos14-arm64/bin/mysqld mysql-8.0.40-macos14-x86_64/bin/mysqld -output mysql-universal/bin/mysqld
          for lib in mysql-8.0.40-macos14-arm64/lib/*.dylib; do
            libname=$(basename "$lib")
            if [ -f "mysql-8.0.40-macos14-x86_64/lib/$libname" ]; then
              lipo -create "$lib" "mysql-8.0.40-macos14-x86_64/lib/$libname" -output "mysql-universal/lib/$libname"
            else
              cp "$lib" "mysql-universal/lib/$libname"
            fi
          done
          tar czf mysql-8.0.40-darwin-universal.tar.gz -C mysql-universal .

      - name: Download MySQL (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.40-linux-glibc2.28-x86_64.tar.xz
          tar xf mysql-8.0.40-linux-glibc2.28-x86_64.tar.xz
          mkdir -p mysql-linux
          cp -r mysql-8.0.40-linux-glibc2.28-x86_64/bin mysql-linux/
          cp -r mysql-8.0.40-linux-glibc2.28-x86_64/lib mysql-linux/
          tar czf mysql-8.0.40-linux-amd64.tar.gz -C mysql-linux .

      - name: Download MySQL (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          curl -L https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.40-winx64.zip -o mysql.zip
          7z x mysql.zip
          mkdir mysql-windows
          xcopy mysql-8.0.40-winx64\bin mysql-windows\bin\ /E /I
          xcopy mysql-8.0.40-winx64\lib mysql-windows\lib\ /E /I
          cd mysql-windows
          7z a ../mysql-8.0.40-windows-amd64.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/binaries-')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: binaries/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
